#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <errno.h>

typedef unsigned int __u32;
typedef  int __s32;

struct msm_hwacc_buf_cfg {
	__u32 input_len;
	__u32 output_len;
};

struct msm_hwacc_data_config {
	__u32 buf_size;
	__u32 num_buf;
	__u32 num_channels;
	__u8 channel_map[8];
	__u32 sample_rate;
	__u32 bits_per_sample;
};

struct msm_hwacc_effects_config {
	struct msm_hwacc_data_config input;
	struct msm_hwacc_data_config output;
	struct msm_hwacc_buf_cfg buf_cfg;
	__u32 meta_mode_enabled;
	__u32 overwrite_topology;
	__s32 topology;
};

#define AUDIO_IOCTL_MAGIC 'a'

#define _IOC_NRBITS	8
#define _IOC_TYPEBITS	8

/*
 * Let any architecture override either of the following before
 * including this file.
 */

#ifndef _IOC_SIZEBITS
# define _IOC_SIZEBITS	14
#endif

#ifndef _IOC_DIRBITS
# define _IOC_DIRBITS	2
#endif

#define _IOC_WRITE	1U
#define _IOC_TYPECHECK(t) (sizeof(t))



#define _IOC_NRMASK	((1 << _IOC_NRBITS)-1)
#define _IOC_TYPEMASK	((1 << _IOC_TYPEBITS)-1)
#define _IOC_SIZEMASK	((1 << _IOC_SIZEBITS)-1)
#define _IOC_DIRMASK	((1 << _IOC_DIRBITS)-1)

#define _IOC_NRSHIFT	0
#define _IOC_TYPESHIFT	(_IOC_NRSHIFT+_IOC_NRBITS)
#define _IOC_SIZESHIFT	(_IOC_TYPESHIFT+_IOC_TYPEBITS)
#define _IOC_DIRSHIFT	(_IOC_SIZESHIFT+_IOC_SIZEBITS)
#define _IOC(dir,type,nr,size) \
	(((dir)  << _IOC_DIRSHIFT) | \
	 ((type) << _IOC_TYPESHIFT) | \
	 ((nr)   << _IOC_NRSHIFT) | \
	 ((size) << _IOC_SIZESHIFT))

#define _IOW(type,nr,size)	_IOC(_IOC_WRITE,(type),(nr),(_IOC_TYPECHECK(size)))
#define AUDIO_EFFECTS_SET_PP_PARAMS _IOW(AUDIO_IOCTL_MAGIC, 104, void *)
#define AUDIO_SET_EFFECTS_CONFIG   _IOW(AUDIO_IOCTL_MAGIC, 99, struct msm_hwacc_effects_config)
#define AUDIO_START        _IOW(AUDIO_IOCTL_MAGIC, 0, unsigned)

#define ASM_STREAM_POSTPROC_TOPO_ID_SA_PLUS 0x1000FFFF

int main(int argc, char *argv[])
{
	printf("main begins...\n");
	printf(".................\n");
	printf("open device...\n");
	int  fd = open("/dev/msm_hweffects", 0);
        if (fd<0){
		perror("open");
		exit(-1);
         }
         printf("config device...\n");
         
         //config audio effect
         int ret = 0;
         unsigned int cmd = AUDIO_SET_EFFECTS_CONFIG;
         //struct msm_hwacc_effects_config *pconfig = (struct msm_hwacc_effects_config *)malloc(sizeof(struct msm_hwacc_effects_config));
         struct msm_hwacc_data_config fake1;
         struct msm_hwacc_buf_cfg fake2;
         struct msm_hwacc_effects_config config;
         struct msm_hwacc_effects_config fake_config;
         //pconfig->topology = ASM_STREAM_POSTPROC_TOPO_ID_SA_PLUS;
         
         //config.topology = ASM_STREAM_POSTPROC_TOPO_ID_SA_PLUS;
         //config.output.buf_size = 0x80000001;
         //config.output.num_buf = 2;
         config.output.bits_per_sample = 24;
         config.meta_mode_enabled = 1;
         
         memcpy(&fake_config, &config, sizeof(struct msm_hwacc_effects_config));
         printf("test fake config top:0x%x \n",fake_config.topology);
         
         
         
	 //ret =ioctl(fd, cmd, pconfig);
	 ret = ioctl(fd, cmd, &config);
	 printf("config done, ret:0x%x \n",ret);
	 
	 printf("set top...\n");
	 
	 ret =ioctl(fd, AUDIO_START, 0);
	 printf("set top done, ret:0x%x \n",ret);
         
         printf("set pp...\n");
         
         long req[128] = {0};
         req[0] = 0x4000;
         req[1] = 0;
         req[2] = 1;
         req[3] = 0x00004002;
         req[5] = 0x0;
         req[6] = 0x8;
         req[9] = 0x1;
         req[10] = -10;

         cmd = AUDIO_EFFECTS_SET_PP_PARAMS;//0x40046168;
	 ret =ioctl(fd, cmd, &req);
	 
	 
       
	printf("main done,ret2:0x%x, cmd is:0x%x \n", ret,cmd);

}
